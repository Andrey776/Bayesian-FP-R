T <-
  100
r <-
  c(0.00772350021659708, -0.00456377179315092, -0.0126939386473722, 
    -0.00681552863383975, -0.0942031356045036, 0.0170324550131086, 
    -0.044741924070753, -0.0447658889224589, 0.0743792750926505, 
    -0.0566695852218029, -0.0747201201368554, 0.11608805520486, 0.128696285889934, 
    -0.0592428755626348, 0.0885016024039413, 0.0368368830084325, 
    0.127097596932183, -0.248683558010108, -0.171797881756833, -0.137112649869262, 
    0.196623171413448, -0.0115871650859353, -0.188529190887615, -0.120494708721148, 
    0.146520625206363, 0.216964354355055, -0.271596972285902, 0.0654845299846823, 
    0.0466439275076377, 0.255421656900248, 0.216719901063377, -0.127259184774919, 
    -0.253329937586891, 0.281625132785514, 0.439718553716349, -0.8478141963257, 
    -0.469711394579493, 0.248398888942335, -0.242897568847547, -0.530965930050346, 
    -0.0053297268941809, 0.735698445109665, 0.18490856612703, 0.127760136506697, 
    -0.0034634136400536, 0.301910145892668, 0.426844849718243, -0.676485527270517, 
    -0.342310419652432, -0.550984182146085, 0.169371078800777, 0.492150811587961, 
    0.685464155581398, -0.262656006821234, 0.13177554878599, 0.107134021012321, 
    0.721404934514682, -0.4664430796768, 0.180655437189, 0.478991858827746, 
    0.085304653150037, -0.683827986508056, -0.208597203786403, 0.557613404917082, 
    -0.118624018005486, 0.838391550391441, 0.958690391764635, -0.349180361889636, 
    0.797287198449248, -1.01250593231994, -0.508582418981559, 0.044193076170752, 
    -0.170394229723711, 0.428687194493968, -0.253970113255018, -0.256361595169114, 
    0.46708004608767, 0.809212434017766, 0.0508118430895749, 0.606820295576031, 
    0.153575487036015, 1.02425961748063, 0.195348491750956, -0.646656836278162, 
    -1.06718382792014, -0.587994390591247, 1.3329339234532, 0.153647361800513, 
    1.10564465124318, -0.499212076828015, 0.781578780066783, -0.80992075615943, 
    0.119765100971179, 0.926195712721799, 0.157739326456987, -0.857659244735319, 
    -0.245912876608471, -0.885013544783891, 0.665706591423521, 1.31330662259241
  )
sigma1 <-
  0.01
T_out <-
  10

stan_dat = list(T=T, r = r, sigma1 = sigma1, T_out= T_out)
garch11 = "
data {
  int<lower=2> T; 
  real r[T];
  real<lower=0> sigma1;
  int<lower=0> T_out;
}
parameters {
  real mu; 
  real<lower=0> alpha0;          
  real<lower=0,upper=1> alpha1;  
  real<lower=0, upper=(1-alpha1)> beta1; 
}
transformed parameters {
  real<lower=0> sigma[T];
  sigma[1] = sigma1;
  for (t in 2:T)
    sigma[t] = sqrt(alpha0 +
                     + alpha1 * square(r[t - 1] - mu)
                     + beta1  * square(sigma[t - 1]));
}
model {
  r ~ normal(mu,sigma);
}
generated quantities {
  real r_out[T_out];
  real sigma_out[T_out];
  sigma_out[1] = sqrt(alpha0 + alpha1 * square(r[T] - mu) + beta1 * square(sigma[T]));
  r_out[1] = normal_rng(mu, sigma_out[1]);
  for (t in 2:T_out) {
    sigma_out[t] = sqrt(alpha0 + alpha1 * square(r_out[t - 1] - mu) 
                        + beta1 * square(sigma_out[t - 1]));
    r_out[t] = normal_rng(mu, sigma_out[t]);
  }
}
"
y_fit = stan(model_code = garch11, data = stan_dat, iter = 10^4, chains = 4)
summary(y_fit)$summary[,"Rhat"]
summary(y_fit)$summary[,c("mean", "50%","2.5%", "97.5%")]
alpha0=extract(y_fit, pars="alpha0")[[1]]
sigma_out_2 = extract(y_fit, pars="sigma_out[2]")[[1]]
str(sigma_out_2)
summary(sigma_out_2)
plot(density(sigma_out_2))
